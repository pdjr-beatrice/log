# log.cfg

## Purpose

`log.cfg` is text file containing *rule*s, grouped into named
*paragraph*s, which specify the data to be written into a daily log
file.
Each rule gives a description for the associated log entry, specifies
the format of the entry data, and supplies either a constant value or,
more usually, an HTTP API query from which the entry data can be
retrieved.

`log.cfg` is read by the `log-update` script which processes rules is
specified paragraphs to generate entries in the daily log.

## Log configuration format

Here is an example of a simple `log.cfg` designed to record vessel
position at the start of each day and log the vessel's track when it is
navigating.

```none
[INIT]
Position          POSITION        /signalk/v1/api/vessels/self/navigation/position

[RUN]
Main engine       STATE           /signalk/v1/api/vessels/self/electrical/switches/bank/16/16/state
>Position         POSITION        /signalk/v1/api/vessels/self/navigation/position
```

This file contains two paragraphs, `[INIT]` and `[RUN]`, and a handful
of rules.

The `[INIT]` paragraph name is special and defines a collection of
rules which will be automatically executed each time `log-update`
creates a new daily log file, thus generating a consistent set of log
entries at the beginning of every log.

In the example file there is only this one rule (although any number
could be listed):

```none
Position POSITION /signalk/v1/api/vessels/self/navigation/position
```

This rule forces an entry called "Position" containing a value of type
`POSITION` to be written into a daily log file as soon as it is created
by a call to `log-update`.
The log file entry will look something like this:

```
2025-06-12T00:00:01_CEST [2025-06-11T22:00:03.260Z] Position POSITION { "latitude": 51.688248, "longitude": 5.318650 }
```

The `[RUN]` paragraph name is user defined and its contained rules will
only be processed when when the paragraph name 'run' is passed as an
argument to `log-update`.





if the `[INIT]` are automatically executed whenever a new daily log file is
created and will generate the fist lines in a daily log. 
Each rule is a line of text with the general format:

The `log-update` command takes one or more paragraph names as its
arguments and processes the rules contained in the specified
paragraphs.
The `[INIT]` paragraph is executed automatically by `log-update` if
command execution has required the creation of a new daily log file.


\[*modifiers*\]*identifier* *function* (*const* | *url*)

where:

*modifiers* is an optional list of one or more modifier characters
which can be used to disable processing of the rule.

| Modifier | Description |
|---       |---          |
| >        | Apply the rule only if the immedialtely preceeding non-modified rule returned the value 1. |
| !        | Apply the rule only if the log file does not contain an entry for *identifier* |

*description is an arbitrary text which will be written to the log file
to uniquely identify the entry generated by this rule.

Each rule specifies an entry which will be placed in the daily log file
(unless one of the *modifier* disabled the rule).


which are
grouped into named *paragraphs*.
The rules in a particular paragraph or paragraphs are applied by
specifying their names as arguments to `log-update`.

```
[PARA]
rult

Paragraph names are arbitrary text strings enclosed in square brackets
with the exception of the `[INIT]` name which is reserved for system
use.
The `log-update` program creates and updates a collection of daily log
files in a configurable *log directory*.
Each day a new file with the name *YYYYMMDD* is created at 00:00Z, is
updated throughout the day, and is closed at 23:59:45Z.

Exactly what data `log-update` places in the daily log is specified
by the configuration file `log.cfg` which is typically located in the
host systems `/usr/local/etc/` folder.

Each time `log-update` is executed, the name of the rule paragraph or
paragraphs that should be processed must be specified.
The simplest way of generating a log is to configure the host system
`/etc/crontab/` so that `log-update` is executed at appropriate time
intervals.

The following example `log.cfg` consists of three paragraphs.

The *INIT* paragraph is automatically executed before any user defined
paragraphs when a new daily log file is created.
This will result in two entries at the start of every daily log
recording the state of charge of the domestic battery bank and the
position of the vessel.

The *RUN* and *CLOSE* paragraphs group some rules which can be executed
by `log-update`.

The *RUN* paragraph logs the current engine state and if this is 1 (on)
then logs the position of the vessel.
The pragraph will only be executed when it is explicitly named as an
argument to `log-update`; repeatedly executing the command
`log-update run` will record the vessel's track when the engine is
running.
As a general point, note that `log-update` only writes an entry to the
log file when the entry differs from the most recently recorded value,
so the log will not fill with repeated entries noting engine on.

The *CLOSE* paragraph logs the domestic battery state and will only
be executed when it is explicitly named as an argument to `log-update`.

```none
[INIT]
PERCENT Battery http://192.168.1.1:3000/signalk/v1/api/vessels/self/electrical/batteries/278/capacity/stateOfCharge
POSITION Position http://192.168.1.1:3000/signalk/v1/api/vessels/self/navigation/position

[RUN]
STATE Engine http://192.168.1.1:3000/signalk/v1/api/vessels/self/electrical/switches/bank/16/16/state
>POSITION Position http://192.168.1.1:3000/signalk/v1/api/vessels/self/navigation/position

[CLOSE]
PERCENT Battery http://192.168.1.1:3000/signalk/v1/api/vessels/self/electrical/batteries/278/capacity/stateOfCharge
```

A typical approach to log file generation is to use the host system's
cron mechanism to automatically execute `log-update`.
The following entries in `/etc/crontab` are suitable for the log
configuration discussed above.

```cron
*/1 *    * * *   root    /usr/local/bin/log-update run >/dev/null 2>/dev/null
58  23   * * *   root    /usr/local/bin/log-update close  >/dev/null 2>/dev/null
```

The first `crontab` entry executes the *RUN* paragraph every minute
through the day.

The second `crontab` entry executes the *CLOSE* paragraph at one minute
before midnight to generate closing entries in the ship's log.

On BEATRICE, at the end of each day I use the `log-email` script to post
the day's log and a derived KML file rendering the vessel's track to my
remote WordPress site for display.
This is easily accomplished with an additional `crontab` entry.

```cron
59  23   * * *   root    /usr/local/bin/log-email  >/dev/null 2>/dev/null
```

## log.cfg

The `log.cfg` file consists of one or more named paragraphs each of
which contains a sequence of rules.

Each rule has the general format:

```none
[modifier]type label url
```

Where:

*modifier* is an optional character ('!' or '>') which modifieds how
the rule is applied (see discussion below).

*type* is a label which specifies how the data returned by *url* should
be processed before being saved to the log file (see discussion below).

*label* is a identifier for this entry in the log.

*url* is a Signal K API URL which returns a data value from Signal K
(or somewhere).

Here is an example of a rule.

```none
STATE Engine http://192.168.1.1:3000/signalk/v1/api/vessels/self/electrical/switches/bank/16/16/state
```

*type* understands the following values:

| Type name | Input value | Output value |
|---        |---          |---           |
| RATIO     | FP in the range 0..1. | Rounded to four decimal places. |
| PERCENT   | FP in the range 0..1. | Multiplied by 10 and rounded to 0 decimal places. |
| POSITION  | { lat: lat, lon: lon } | lat and lon rounded to four decimal places. |
